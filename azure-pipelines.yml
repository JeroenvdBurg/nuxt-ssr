# Run On PRs against all branches
pr:
  branches:
    include:
      - "*"
# Run on changes to main or dev or release branches
trigger:
  batch: true
  branches:
    include:
      - main
      - develop

pool:
  vmImage: "ubuntu-latest"

variables:
  bicepRegistryServiceConnection: "Bicep registry"
  azureServiceConnection: "Q42 Development"
  location: "westeurope"

  isMainBranch: $[eq(variables['Build.SourceBranch'], 'refs/heads/main')]

stages:
  - stage: BuildInfra
    displayName: Build Infra
    jobs:
      - template: "azure-pipelines/infra-build.yml"
        parameters:
          workingDir: IaC-Bicep
          sourceFile: "main.bicep"
          artifactName: "Nuxt.Infra"

  - stage: DeployInfra
    displayName: Deploy Infra
    condition: and( succeeded() , eq(variables.isMainBranch, true) )
    dependsOn:
      - BuildInfra
    jobs:
      - template: "azure-pipelines/infra-deploy.yml"
        parameters:
          workingDir: $(Pipeline.Workspace)/Nuxt.Infra/IaC-Bicep
          environment: "main"
          variableGroupName: "main"

  - stage: BuildApp
    displayName: Build App
    jobs:
      - job: Build
        steps:
          - task: UseNode@1
            inputs:
              version: "18.x"

          - task: Npm@1
            displayName: "npm install"
            inputs:
              command: "install"
              workingDir: "src"

          - task: Npm@1
            displayName: "npm build"
            inputs:
              command: "custom"
              workingDir: "src"
              customCommand: "run build"

          - task: AzureCLI@2
            inputs:
              azureSubscription: $(azureServiceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                export SWA_CLI_DEPLOYMENT_TOKEN=e1c4f03be2b0c40edd7c4f780f58bf386f526f85c6cc6c8da1d743a6fb47b4092-b0236354-6647-4998-a7ca-d2acbae166d0003165990
                npm install -g @azure/static-web-apps-cli
                swa deploy .output/public --api-location .output/server
              workingDirectory: src
